___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "displayName": "Sklik",
  "categories": ["REMARKETING", "ANALYTICS", "ADVERTISING"],
  "description": "Conversion \u0026 remarketing code for Sklik. Supporting RC.js code form May 2020.\n@author House of Rezac\n@version 2020-05-19",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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\u003d\u003d",
    "displayName": "",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "clearOnCopy": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "displayName": "ID *",
    "simpleValueType": true,
    "name": "id",
    "type": "TEXT"
  },
  {
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "Conversion",
        "value": "conversion"
      },
      {
        "value": "retargeting",
        "displayValue": "Retargeting"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Code Type *",
    "simpleValueType": true,
    "name": "codetype",
    "type": "SELECT"
  },
  {
    "enablingConditions": [
      {
        "paramName": "codetype",
        "type": "EQUALS",
        "paramValue": "conversion"
      }
    ],
    "displayName": "Order",
    "name": "conversion",
    "groupStyle": "NO_ZIPPY",
    "type": "GROUP",
    "subParams": [
      {
        "type": "TEXT",
        "name": "orderId",
        "displayName": "Order ID",
        "simpleValueType": true,
        "canBeEmptyString": false
      },
      {
        "clearOnCopy": false,
        "displayName": "Revenue",
        "simpleValueType": true,
        "name": "revenue",
        "valueUnit": "",
        "type": "TEXT"
      }
    ]
  },
  {
    "enablingConditions": [
      {
        "paramName": "codetype",
        "type": "EQUALS",
        "paramValue": "retargeting"
      }
    ],
    "displayName": "Retargeting",
    "name": "remarketing",
    "groupStyle": "NO_ZIPPY",
    "type": "GROUP",
    "subParams": [
      {
        "clearOnCopy": false,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "displayName": "Model type",
        "defaultValue": "vars",
        "simpleValueType": true,
        "name": "model",
        "type": "RADIO",
        "radioItems": [
          {
            "displayValue": "Measurement Hub",
            "value": "mh"
          },
          {
            "displayValue": "Standard Variables",
            "value": "vars"
          }
        ],
        "help": "Measuremet Hub is object oriented standard of dataLayer. Standard variables means separated values for each Sklik parameter."
      },
      {
        "notSetText": "Not set",
        "clearOnCopy": false,
        "macrosInSelect": true,
        "selectItems": [],
        "enablingConditions": [
          {
            "paramName": "model",
            "type": "EQUALS",
            "paramValue": "mh"
          }
        ],
        "displayName": "{{aac.page}}",
        "simpleValueType": true,
        "name": "page",
        "type": "SELECT"
      },
      {
        "notSetText": "Not set",
        "clearOnCopy": false,
        "macrosInSelect": true,
        "selectItems": [],
        "enablingConditions": [
          {
            "paramName": "model",
            "type": "EQUALS",
            "paramValue": "mh"
          }
        ],
        "displayName": "{{aac.products}}",
        "defaultValue": "{{aac.products}}",
        "simpleValueType": true,
        "name": "products",
        "type": "SELECT"
      },
      {
        "help": "Category will use {{aac.page}}[KEY] value. If not set, standard category value will be used.",
        "enablingConditions": [
          {
            "paramName": "page",
            "type": "PRESENT",
            "paramValue": ""
          }
        ],
        "displayName": "Category Key",
        "simpleValueType": true,
        "name": "categorySeznamKey",
        "type": "TEXT",
        "canBeEmptyString": true
      },
      {
        "notSetText": "Not set",
        "macrosInSelect": false,
        "selectItems": [
          {
            "displayValue": "Category",
            "value": "category"
          },
          {
            "displayValue": "Offer detail",
            "value": "offerdetail"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "model",
            "type": "EQUALS",
            "paramValue": "vars"
          }
        ],
        "displayName": "Page type",
        "simpleValueType": true,
        "name": "pagetype",
        "type": "SELECT"
      },
      {
        "enablingConditions": [
          {
            "paramName": "pagetype",
            "type": "EQUALS",
            "paramValue": "offerdetail"
          }
        ],
        "displayName": "Item ID",
        "simpleValueType": true,
        "name": "itemId",
        "type": "TEXT",
        "canBeEmptyString": false
      },
      {
        "enablingConditions": [
          {
            "paramName": "pagetype",
            "type": "EQUALS",
            "paramValue": "category"
          }
        ],
        "displayName": "Category",
        "simpleValueType": true,
        "name": "category",
        "type": "TEXT",
        "canBeEmptyString": false
      }
    ]
  },
  {
    "displayName": "URL",
    "simpleValueType": true,
    "name": "url",
    "type": "TEXT",
    "canBeEmptyString": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

/**
 * @version 2019-08-23
 */

const log = require('logToConsole');
const sendPixel = require('sendPixel');
const encodeUriComponent = require('encodeUriComponent');
const getCookieValues = require('getCookieValues');
const getUrl = require('getUrl');
const Math = require('Math');



if (data.codetype === 'retargeting') {
  let params = {
    'id': data.id,
    'url': data.url ? data.url : getUrl()
  };

  let sid = getCookieValues('sid');
  sid = (sid && sid.length) ? sid[0] : '';
  params.dsid = sid;

  
  if (data.model === 'mh') {
    if (data.page && data.page.type) {
      if (data.page.type.indexOf('detail') > -1) {
        params.pagetype = 'offerdetail';
      } else if (data.page.type.indexOf('category') > -1) {
        params.pagetype = 'category';
      }
    }
    if (data.products && data.products.length) {
      params.itemId = data.products[0].id || '';
    }
    if (data.categorySeznamKey) {
      params.category = data.page[data.categorySeznamKey] || '';
    } else {
      params.category = ((data.page && data.page.category) ? data.page.category.replaceAll('/', ' | ') : '') || '';
    }

  } else {
    if (data.pagetype) params.pagetype = data.pagetype || '';
    if (data.itemId) params.itemId = data.itemId || '';
    if (data.category) params.category = (data.category || '').split('/').join(' | ');
  }
  
  let paramsStr = '';
  for (let key in params) {
    if (params[key])
      paramsStr += '&' + key + '=' + encodeUriComponent(params[key]);
  }
  let url = 'https://c.imedia.cz/retargeting?' + paramsStr.substring(1);
  sendPixel(url, () => {
    log('SKLIK RETARGETING', params, url);
    data.gtmOnSuccess(); 
  }, data.gtmOnFailure);  


  

} else if (data.codetype === 'conversion') {

  let orderId = (data.model === 'mh' ? data.order.id : data.orderId) || '';
  let revenue = (data.model === 'mh' ? data.order.revenue : data.revenue) || null;
  let sid = getCookieValues('sid');
  sid = (sid && sid.length) ? sid[0] : '';
  
  let url = 'https://c.imedia.cz/conv?id=' + data.id;
  url += '&orderId=' + encodeUriComponent(orderId);
  url += '&value=' + (revenue ? (Math.round(revenue*100) / 100) : '');

  if (sid) {
    let encodedSid = encodeUriComponent(sid);
    url += '&lsid=' + encodedSid;
    url += '&dsid=' + encodedSid;
  }
  url += '&url=' + encodeUriComponent(data.url ? data.url : getUrl());

  sendPixel(url, () => {
    data.gtmOnSuccess();
    log('SKLIK CONVERSION: status success', url, {'id': data.id, 'orderId': orderId, 'revenue': revenue, 'sid': sid});
  }, () => {
    data.gtmOnFailure();
    log('SKLIK CONVERSION: status failure', url, {'id': data.id, 'orderId': orderId, 'revenue': revenue, 'sid': sid});
  });

} else {
  log('Unknown codetype ' + data.codetype);

}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://c.imedia.cz/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "sid"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Conversion - request was sent
  code: |-
    mock('sendPixel', function(url, onSuccess, onFailure) {
      assertThat(url).isEqualTo('https://c.imedia.cz/conv?id=ID123&orderId=T_112233&value=99.12&url=https%3A%2F%2Ftagmanager.googleusercontent.com%2Fjs_sandbox_v2.html');
    });


    // Call runCode to run the template's code.
    runCode(conversionData);
    assertApi('sendPixel').wasCalled();
    assertApi('getCookieValues').wasCalled();
- name: Conversion - URL can be submitted
  code: |-
    conversionData.url = 'https://www.example.com/foo?bar=baz';

    mock('sendPixel', function(url, onSuccess, onFailure) {
      assertThat(url).isEqualTo('https://c.imedia.cz/conv?id=ID123&orderId=T_112233&value=99.12&url=https%3A%2F%2Fwww.example.com%2Ffoo%3Fbar%3Dbaz');
    });


    runCode(conversionData);
    assertApi('sendPixel').wasCalled();
- name: Conversion - SID cookie can be readed
  code: |-
    mock('sendPixel', function(url, onSuccess, onFailure) {
      assertThat(url).isEqualTo('https://c.imedia.cz/conv?id=ID123&orderId=T_112233&value=99.12&lsid=ABC%20123&dsid=ABC%20123&url=https%3A%2F%2Ftagmanager.googleusercontent.com%2Fjs_sandbox_v2.html');
    });

    mock('getCookieValues', ['ABC 123']);

    // Call runCode to run the template's code.
    runCode(conversionData);
    assertApi('getCookieValues').wasCalled();
- name: Retargeting - request was sent
  code: |-
    mock('sendPixel', function(url, onSuccess, onFailure) {
      assertThat(url).isEqualTo('https://c.imedia.cz/retargeting?id=ID123&url=https%3A%2F%2Ftagmanager.googleusercontent.com%2Fjs_sandbox_v2.html');
    });

    runCode(retargetingData);
    assertApi('sendPixel').wasCalled();
- name: Retargeting - SID cookie can be readed
  code: |-
    mock('sendPixel', function(url, onSuccess, onFailure) {
      assertThat(url).isEqualTo('https://c.imedia.cz/retargeting?id=ID123&url=https%3A%2F%2Ftagmanager.googleusercontent.com%2Fjs_sandbox_v2.html&dsid=ABC%20123');
    });

    mock('getCookieValues', ['ABC 123']);

    runCode(retargetingData);
    assertApi('sendPixel').wasCalled();
    assertApi('getCookieValues').wasCalled();
- name: Retargeting - URL can be submitted
  code: |-
    retargetingData.url = 'https://www.example.com/foo?bar=baz';
    mock('sendPixel', function(url, onSuccess, onFailure) {
      assertThat(url).isEqualTo('https://c.imedia.cz/retargeting?id=ID123&url=https%3A%2F%2Fwww.example.com%2Ffoo%3Fbar%3Dbaz');
    });

    runCode(retargetingData);
    assertApi('sendPixel').wasCalled();
- name: Retargeting - category page - standard
  code: |-
    retargetingData.model = 'vars';
    retargetingData.pagetype = 'category';
    retargetingData.category = 'Jidlo/Pecivo/Bile pecivo/Rohliky';

    mock('sendPixel', function(url, onSuccess, onFailure) {
      assertThat(url).isEqualTo('https://c.imedia.cz/retargeting?id=ID123&url=https%3A%2F%2Ftagmanager.googleusercontent.com%2Fjs_sandbox_v2.html&pagetype=category&category=Jidlo%20%7C%20Pecivo%20%7C%20Bile%20pecivo%20%7C%20Rohliky');
    });

    runCode(retargetingData);
    assertApi('sendPixel').wasCalled();
- name: Retargeting - offerdetail page - standard
  code: |-
    retargetingData.model = 'vars';
    retargetingData.pagetype = 'offerdetail';
    retargetingData.itemId = 'ITEM_123/4';

    mock('sendPixel', function(url, onSuccess, onFailure) {
      assertThat(url).isEqualTo('https://c.imedia.cz/retargeting?id=ID123&url=https%3A%2F%2Ftagmanager.googleusercontent.com%2Fjs_sandbox_v2.html&pagetype=offerdetail&itemId=ITEM_123%2F4');
    });

    runCode(retargetingData);
    assertApi('sendPixel').wasCalled();
setup: |-
  let conversionData = {
    'codetype': 'conversion',
    'model': 'vars',
    'id': 'ID123',
    'revenue': 99.123,
    'orderId': 'T_112233'
  };


  let retargetingData = {
    'id': 'ID123',
    'codetype': 'retargeting'
  };


___NOTES___

Created on 17. 5. 2020 0:30:14


