___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "displayName": "Sklik",
  "categories": [
    "REMARKETING",
    "ANALYTICS",
    "ADVERTISING"
  ],
  "description": "Conversion \u0026 remarketing code for Sklik \u0026 Zbozi.\n\n@author Pavel Sabatka\n@version 2024-02-16",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TiyIVBzNIUchQnSyIioiTVLEIFkpboVUHk0u/oElD0uLiKLgWHPxYrDq4OOvq4CoIgh8gTo5Oii5S4v+SQosYD4778e7e4+4dIDTKTLO6xgFNr5rJWFTKZFel7lcEEIKIYczKzDLiqcU0PMfXPXx8vYvwLO9zf44+NWcxwCcRzzHDrBJvEE9vVg3O+8QiK8oq8TnxmEkXJH7kuuLyG+eCwwLPFM10cp5YJJYKHax0MCuaGvEUcVjVdMoXMi6rnLc4a+Uaa92TvzCY01dSXKc5hBiWEEcCEhTUUEIZVURo1UmxkKT9qIc/5PgT5FLIVQIjxwIq0CA7fvA/+N2tlZ+ccJOCUSDwYtsfI0D3LtCs2/b3sW03TwD/M3Clt/2VBjDzSXq9rYWPgP5t4OK6rSl7wOUOMPhkyKbsSH6aQj4PvJ/RN2WBgVugd83trbWP0wcgTV0t3wAHh8BogbLXPd7d09nbv2da/f0A4uBy1PeVI+IAAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfkBRoULx3ccJSnAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAACsBJREFUeNrtnXtsU3Ubx7/nnPa069puXTe2zm7gENSNQBgSNMtAebNMJaCwDEi4E8UoRAIIAnMQLgpRSRgaGaAmk2EEHYkQ52CIInLLgISBQ2FMYBd3a9f2tF2v57x/8PIGTRRGz689p+034T/263P66fP8nud3eQ4lCIKAuCQjhZyMFfx++Do74b19G/72dvAOB4J2O3iLBcHubvB//AH+yhVQZjMooxGUXg9KqwWVmAgmIwNMWhoYoxFMUhIUBgMUgwZBmZoKJjFRMs9ISdlDAg4HPNeuwdvcDM/Fi/BVVQHd3aJ/Dj1xIlTPPQfV6NFQDxsGNisLTEJCHMhdL3A3NcFZXw/3xo0Ax0XEDnbtWmiLiqAZORLKlJTYA+JtbQV38iRclZXgT56UlKeyK1ZAX1qKxNGjQbNsdAPxW62wVlfDvXSp5OcwuqAAuhUrkFRcDEajiS4gvNcL+9GjsL/1FoRr12SVCdEFBUhavx76CRNE95iIAHGePw/r5s0IfvutrFNUZvJkJK9eDd24caAYRn5ABJ6H5auvwM2aFVW1g+H775H8/PPieF/YQpTPh+6KiqiDAQCap54SLxyGw+Cg04k/y8vhXr486mCoN2wAm5oqn0rd39eHzqVLEdi7NyqXOnSTJ4ubMJDOpLreeSdqYdCFhdCMGCETIIKAnp074f/kE0SrtEuWgFYq5ZH2cmfPoveZZxDNyuzogMpkkr6HBDgO1lWrohoGu3Kl6DCIAbHW1EhuPUps6adNIzKu6CHL39eHtieeILJMLhVR+fnIPnUKtFotfQ9x1NdHNQwASFy6lAgM0esQIRCAc8eOiHxJzKRJoLOzQaemgmIYCB4PBI8HvMMB/vffwZ86JV7tMWECsecQFYjnxg1RH/xfAZSUQDtnDhLy8sCaTPfdhhUCAQScTgS6uuBrb4e3pQW+ixfhr64e0CaY8vXXoR48mFw4FHMO6d23D9zs2WRBzJ4N48qV0IwYAYoOPeLyfj98ra1wXbgA1zffIHjgwL/+f+OJE9CPHy8PIG2LFxMtBLWffYbUuXNBKcit+Pja2+G6dAnOmhoEPv/8r19WTg6yGhuJHooQDQjv9+OW0UhsD1y/fz+M06eHb1ISBPQ3N8NeV4f+sjKA45C4axcGLVpENoMTC4ivvR3tZjMRI1WrV8O0ebNom0ADLnRtNnCnTyMhNxfqIUPkAcR99Sq6cnOJGGlqboZ66FDEgkSrQ/j+fmKTuDonB7EiyQNRjR0LUFQciFTEiLgbF1NAGJ2OiIHB3t44ECkB6a+uBu/xxIEMeCCtlkw50NAAS5RuARNNe4NuN24TrGCNP/8MfWFh3EMeOGQlJIAaPpyYoZbx42E5cABCMBgH8mC+RiHh1VeJGuuYMQN/lpfD29ERD1kPIu70afQWFITFcO2nnyK5pATK5OQ4kH+Sv68PbeG83JKTA+26ddAXF4PNyIiHrL9LaTCAffPNsBkvtLSAmz8f7SYTOt9/H/2//QaB5+Mecq9sx46hr6goYg+kmDkTugULoB03DoqkpDgQ3utF24wZkb/7odNBs2kTdMXFSBg+XJTdRVkCAaR3apEpLYV+4UJon34aCoknAUSACMEg2t94A/7du6X1tDodNBs23PGaxx+P2IZX2IEAQP/16+gcMyZi15rv6zVTp0K/aBF0hYWx0zjAfvw4rP/5j7RDRG4utGVl0BcVgU1Li24gANBbVQVu/nxZTKgJO3YgpbQ0ojUNcSBCMIiuLVvQX14uj7xTp4N2+3YkT50KpcEQfUCAO0eEenbvhnvJEvkUBGYz9Nu2wTBlCrFzvBEDcsdVBFgPHYL95ZdlVagxpaVI3bABmiefjDIgd2uUhgZYXnkFQmOjrMAk7toF46xZxDOyiHRy8Fut6K2shKesTF7eUlKC9IoKqB55JLqA3JWzoQGWsjLw9fWygUKNHIm0L75A4qhR0QcEAIIuF+z19XCsXy+rMJZcWwvDCy9EH5D/g3E6YTt6FFx5OYSmJllAMdTWIllkKJLrKBfgODhPnYKjslIW3YLSGhqgFbHXiWR7LgrBINxXrsB+8CC8GzdKul7J+PFHJDz2WHQDuVe+nh64zp0Dt3fvfW84RUL0s8/CfPgwGBHOplGy6tsrCPC0tMBx8iTcH30E4eJFyZimrapC2ty5MQbkHvFeL9y//gqurk4y9YyptRXqEC8t0ZCpaJUK2vx8mNauhdlqheHIESjmzImoTZadO4EQf99UVLUa/19Is9fVwb1mTUQ2x0w3boR0wYhGNImioB46FOmLF8N88yb0X38NauzYsJrgunAh7iH3q2tsNTXgFiwIy+cxU6ciu6bmoW99UbHydgRvWxt6tmwJS0O1zJs3oXrIbg80YkQqsxmZH34I9XvvEf8sdwhrcjEDBADohARkrFoFTUUF2UK2uTkO5IFjNMMgdeFC0BMnkgNy6VIcyIAmXq0WKe++S2z8YENDPMsacKXv8eDWsGFAWxuR8YcEAg91MjImPQQAaLUaiuJicjVqIBAPWQMOXQSvK1AP2c83poH4L18m430FBQ99/SFmgQQ4jtjhCurRR+NZ1kDlOn+e2NgKqQERgkEE7HZJZ1j2v7XvE3VVIC9PWkDcTU1ozcpC1/btcDc1Se6yf291NYLV1cTGZ6XmIY66OoDj4F62DF15eWgtKUHf4cPwWywRBXH3lUsuwg0O2BB2DcVvNW6zoS07+x83h9hVq5BYVATNqFFhvSDjt1hg2bMH/WvWkE2lS0uRvX+/dJbfbUeOoO8BX5ClXLQIiVOmQDNyJFiTiUj7V19vL7hjx+BYuZJYVX6v9DU1MIbQqF9cIIKA1tmzEfjyy4H/rdkM1fTpYEePhionB6zZDGV6OmiVamDprMOBQE8PPNevw/ndd/B//HFYw6Lp5s2QOl+LCqT/+nV0itwRiJ44EUxuLpjMTDBJSaBYFmBZ0EolBJ8PvMsF3ukEb7PBf+YM+J9+itgcpXr7bWRu3RpayiymQdwPP4ifoh4/Dv74cfhlUNskz5sX+g9QLGOCLhfcH3wQs8swquXLRbllJRoQ14ULEFpaYpPGoEEwLlsmTogWrfbYvz9mvSNpzx6oRGqzLsqk7m1tRUd2dkzCYFesQObWraKl7KJ4CHfiREzCUMycifR160Stn0L2EN7rxe3CQggh7CPLUXRBAUw1NWDT08UdN+TJvLEx5mAwkyYh48AB0WGIAsR56FBshal582CqqoIqM5PI+CGFLF93N9oJ/EqkqoRt25D22mtEmweE5CG80wnmpZeiHgQ1fDiMJ04gY/ly6Xdy4H0+cL/8AtvWrbJqAPBAikBnIPFeCubzwXnuHOyVlQ+32isxaSoqYJgxg8jEHRYgdyUEg3fu/tXWEt8MIjJPbNoEw7x5UGVlRSY8kjxK6u/rg+vsWThra8O+LzHQzElbUoLE/HywBBvLRBzIX+BYLHA3NsJ95gy8+/ZFvH2GYv58aKdNg2bMGGIprKSB/CWsBQLwdXTAc+MGvFevwn/5MnwHDxJ7yzSVnw/Viy+CzcsDO2QI2MGDibycXrZA/gmS32qFv7sbQZvtzj+LBf7ubgidneA5DoLLBcFuh2Czgb91C1RKCuhhw0Cnp4M2GkEnJYHW6UBrtVCkpIDNyoIyIwPKlBTZvOktZq8jSFV0/CuQlv4LeziyrrRUUWMAAAAASUVORK5CYII\u003d",
    "displayName": "pavelsabatka",
    "id": "github.com_pavelsabatka"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "Conversion",
        "value": "conversion"
      },
      {
        "value": "retargeting",
        "displayValue": "Retargeting"
      },
      {
        "value": "clear_user_identities",
        "displayValue": "Clear User Identity"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Code Type *",
    "simpleValueType": true,
    "name": "codetype",
    "type": "SELECT"
  },
  {
    "clearOnCopy": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "displayName": "ID *",
    "simpleValueType": true,
    "name": "id",
    "type": "TEXT",
    "help": "Remarketing or conversion ID given from Sklik administration",
    "valueHint": "12345",
    "enablingConditions": [
      {
        "paramName": "codetype",
        "paramValue": "clear_user_identities",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "clearOnCopy": false,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Model type",
    "defaultValue": "vars",
    "simpleValueType": true,
    "name": "model",
    "type": "RADIO",
    "radioItems": [
      {
        "displayValue": "Measurement Hub",
        "value": "mh"
      },
      {
        "displayValue": "Standard Variables",
        "value": "vars"
      }
    ],
    "help": "Measuremet Hub is object oriented standard of dataLayer. Standard variables means separated values for each Sklik parameter.",
    "enablingConditions": [
      {
        "paramName": "codetype",
        "paramValue": "clear_user_identities",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "enablingConditions": [
      {
        "paramName": "codetype",
        "type": "EQUALS",
        "paramValue": "conversion"
      }
    ],
    "displayName": "Conversion",
    "name": "conversion",
    "groupStyle": "NO_ZIPPY",
    "type": "GROUP",
    "subParams": [
      {
        "type": "TEXT",
        "name": "orderId",
        "displayName": "Order ID",
        "simpleValueType": true,
        "canBeEmptyString": false,
        "valueHint": "",
        "help": "Unique transaction ID",
        "enablingConditions": [
          {
            "paramName": "model",
            "paramValue": "vars",
            "type": "EQUALS"
          }
        ]
      },
      {
        "clearOnCopy": false,
        "displayName": "Revenue",
        "simpleValueType": true,
        "name": "revenue",
        "type": "TEXT",
        "help": "Total revenue of transaction",
        "valueHint": "12345.12",
        "enablingConditions": [
          {
            "paramName": "model",
            "paramValue": "vars",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "order",
        "displayName": "{{aac.order}}",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "model",
            "paramValue": "mh",
            "type": "EQUALS"
          }
        ],
        "help": "Object of order"
      },
      {
        "type": "TEXT",
        "name": "zboziId",
        "displayName": "Zbozi.cz shop ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "^(|[0-9]{4,10})$"
            ],
            "enablingConditions": [],
            "errorMessage": "Value must be empty or must be numeric"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "zboziType",
        "displayName": "Zbozi.cz conversion type",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "standard",
            "displayValue": "Standard"
          },
          {
            "value": "limited",
            "displayValue": "Limited"
          },
          {
            "value": "sandbox",
            "displayValue": "Sandbox"
          }
        ],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "zboziId",
            "paramValue": "",
            "type": "PRESENT"
          }
        ],
        "defaultValue": "standard"
      }
    ]
  },
  {
    "enablingConditions": [
      {
        "paramName": "codetype",
        "type": "EQUALS",
        "paramValue": "retargeting"
      }
    ],
    "displayName": "Retargeting",
    "name": "remarketing",
    "groupStyle": "NO_ZIPPY",
    "type": "GROUP",
    "subParams": [
      {
        "notSetText": "Not set",
        "clearOnCopy": false,
        "macrosInSelect": true,
        "selectItems": [],
        "enablingConditions": [
          {
            "paramName": "model",
            "type": "EQUALS",
            "paramValue": "mh"
          }
        ],
        "displayName": "{{aac.page}}",
        "simpleValueType": true,
        "name": "page",
        "type": "SELECT"
      },
      {
        "notSetText": "Not set",
        "clearOnCopy": false,
        "macrosInSelect": true,
        "selectItems": [],
        "enablingConditions": [
          {
            "paramName": "model",
            "type": "EQUALS",
            "paramValue": "mh"
          }
        ],
        "displayName": "{{aac.products}}",
        "simpleValueType": true,
        "name": "products",
        "type": "SELECT"
      },
      {
        "help": "Category will use {{aac.page}}[KEY] value. If not set, standard category value will be used.",
        "enablingConditions": [
          {
            "paramName": "page",
            "type": "PRESENT",
            "paramValue": ""
          }
        ],
        "displayName": "Category Key",
        "simpleValueType": true,
        "name": "categorySeznamKey",
        "type": "TEXT",
        "canBeEmptyString": true
      },
      {
        "notSetText": "Not set",
        "macrosInSelect": true,
        "selectItems": [
          {
            "displayValue": "Category",
            "value": "category"
          },
          {
            "displayValue": "Offer detail",
            "value": "offerdetail"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "model",
            "type": "EQUALS",
            "paramValue": "vars"
          }
        ],
        "displayName": "Page type",
        "simpleValueType": true,
        "name": "pagetype",
        "type": "SELECT",
        "help": "Type of page. Expected values are product.detail, detail, offerdetail (for product detail page) or category (for product category page)"
      },
      {
        "enablingConditions": [],
        "displayName": "Item ID",
        "simpleValueType": true,
        "name": "itemId",
        "type": "TEXT",
        "canBeEmptyString": false,
        "alwaysInSummary": true,
        "help": "ID of product on product detail page"
      },
      {
        "enablingConditions": [],
        "displayName": "Category",
        "simpleValueType": true,
        "name": "category",
        "type": "TEXT",
        "canBeEmptyString": false,
        "alwaysInSummary": true,
        "help": "Category name"
      },
      {
        "displayName": "Custom URL",
        "simpleValueType": true,
        "name": "url",
        "type": "TEXT",
        "canBeEmptyString": true,
        "help": "Custom params can be put into URL here. Hostname and pathname of Custom URL must be same as real URL! Otherwise Sklik will not accept this parameter.\nYou can use it e.g. for scroll tracking or targeting to JS executed actions on page."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "identity",
    "displayName": "User Identity",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "SELECT",
        "name": "user",
        "displayName": "{{aac.user}}",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "model",
            "paramValue": "mh",
            "type": "EQUALS"
          }
        ],
        "alwaysInSummary": true,
        "help": ""
      },
      {
        "type": "TEXT",
        "name": "userEmail",
        "displayName": "Email Hash (recommended) or Email",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "Email hash or Email, recommended.\nIf you enter a non-hashed email, it will be encoded automatically and only the encoded value will be passed to the remarketing code. We recommend passing the email hash directly using the sha256 function, some browsers may not support the hashing function.",
        "enablingConditions": [
          {
            "paramName": "model",
            "paramValue": "vars",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "userPhone",
        "displayName": "Phone",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "Optional. Phone number in format +420777123456",
        "enablingConditions": [
          {
            "paramName": "model",
            "paramValue": "vars",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "userAddress",
        "displayName": "Address",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "country",
            "displayName": "Country",
            "simpleValueType": true,
            "alwaysInSummary": false,
            "help": "Optional. It is possible to submit any format, Seznam use the advanced matching algorithm.",
            "enablingConditions": [
              {
                "paramName": "model",
                "paramValue": "vars",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "city",
            "displayName": "City",
            "simpleValueType": true,
            "alwaysInSummary": false,
            "help": "Optional. It is possible to submit any format, Seznam use the advanced matching algorithm.",
            "enablingConditions": [
              {
                "paramName": "model",
                "paramValue": "vars",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "street",
            "displayName": "Street",
            "simpleValueType": true,
            "alwaysInSummary": false,
            "help": "Optional. It is possible to submit any format, Seznam use the advanced matching algorithm.",
            "enablingConditions": [
              {
                "paramName": "model",
                "paramValue": "vars",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "streetNumber",
            "displayName": "Number",
            "simpleValueType": true,
            "alwaysInSummary": false,
            "help": "Optional. It is possible to submit any format, Seznam use the advanced matching algorithm.",
            "enablingConditions": [
              {
                "paramName": "model",
                "paramValue": "vars",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "postalCode",
            "displayName": "Postal Code",
            "simpleValueType": true,
            "alwaysInSummary": false,
            "help": "Optional. It is possible to submit any format, Seznam use the advanced matching algorithm.",
            "enablingConditions": [
              {
                "paramName": "model",
                "paramValue": "vars",
                "type": "EQUALS"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "model",
            "paramValue": "vars",
            "type": "EQUALS"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "codetype",
        "paramValue": "clear_user_identities",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "identityAdvanced",
    "displayName": "Advanced User Identity",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "TEXT",
        "name": "userSeznamAdId",
        "displayName": "Seznam Ad ID",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "If user is logged on your site with Seznam Identity, you can use advert_user_id. More information is available on https://vyvojari.seznam.cz/identita/said",
        "enablingConditions": [
          {
            "paramName": "model",
            "paramValue": "vars",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "userCzechAdId",
        "displayName": "Czech Ad ID",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "More information is available on https://vyvojari.seznam.cz/identita/secid",
        "enablingConditions": [
          {
            "paramName": "model",
            "paramValue": "vars",
            "type": "EQUALS"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "codetype",
        "paramValue": "clear_user_identities",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consent",
    "displayName": "Consent",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "SELECT",
        "name": "consent_handling",
        "displayName": "How consent status is loaded",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "consent_mode",
            "displayValue": "Use GTM consent mode"
          },
          {
            "value": "consent_variable",
            "displayValue": "Load consent status from variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "consent_mode",
        "alwaysInSummary": false,
        "help": "See documentation for more information."
      },
      {
        "type": "GROUP",
        "name": "consent_mode_config",
        "displayName": "Consent Mode Configuration",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "SELECT",
            "name": "consent_name_remarketing",
            "displayName": "Consent Type for Retargeting",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "ad_storage",
                "displayValue": "ad_storage"
              },
              {
                "value": "analytics_storage",
                "displayValue": "analytics_storage"
              },
              {
                "value": "ad_user_data",
                "displayValue": "ad_user_data"
              },
              {
                "value": "ad_personalization",
                "displayValue": "ad_personalization"
              }
            ],
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "codetype",
                "paramValue": "retargeting",
                "type": "EQUALS"
              }
            ],
            "defaultValue": "ad_storage",
            "help": "",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "SELECT",
            "name": "consent_name_conversion",
            "displayName": "Consent Type for Conversion Tracking",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "ad_storage",
                "displayValue": "ad_storage"
              },
              {
                "value": "analytics_storage",
                "displayValue": "analytics_storage"
              },
              {
                "value": "ad_user_data",
                "displayValue": "ad_user_data"
              },
              {
                "value": "ad_personalization",
                "displayValue": "ad_personalization"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "analytics_storage",
            "enablingConditions": [
              {
                "paramName": "codetype",
                "paramValue": "conversion",
                "type": "EQUALS"
              }
            ],
            "help": "",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "SELECT",
            "name": "consent_name_user_data",
            "displayName": "Consent Type for Personal Data Tracking",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "ad_storage",
                "displayValue": "ad_storage"
              },
              {
                "value": "analytics_storage",
                "displayValue": "analytics_storage"
              },
              {
                "value": "ad_user_data",
                "displayValue": "ad_user_data"
              },
              {
                "value": "ad_personalization",
                "displayValue": "ad_personalization"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "ad_user_data",
            "help": "",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "consent_handling",
                "paramValue": "no_consent",
                "type": "NOT_EQUALS"
              }
            ]
          },
          {
            "type": "CHECKBOX",
            "name": "disableUpdateListener",
            "checkboxText": "Disable Consent Update Listener",
            "simpleValueType": true,
            "defaultValue": false,
            "help": "If enabled, the request is automatically sent after consent is granted. Otherwise, you need to run the tags again to send the data."
          }
        ],
        "enablingConditions": [
          {
            "paramName": "consent_handling",
            "paramValue": "consent_mode",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "consent_variable_config",
        "displayName": "Consent Configuration",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "consent_variable_remarketing",
            "displayName": "Consent Status For Remarketing",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "codetype",
                "paramValue": "retargeting",
                "type": "EQUALS"
              }
            ],
            "help": "Accept values true/false, 1/0, granted/denied"
          },
          {
            "type": "TEXT",
            "name": "consent_variable_conversion",
            "displayName": "Consent Status For Conversion Tracking",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "codetype",
                "paramValue": "conversion",
                "type": "EQUALS"
              }
            ],
            "help": "Accept values true/false, 1/0, granted/denied"
          },
          {
            "type": "TEXT",
            "name": "consent_variable_user_data",
            "displayName": "Consent Status For Transfer of Personal Data",
            "simpleValueType": true,
            "help": "Accept values true/false, 1/0, granted/denied"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "consent_handling",
            "paramValue": "consent_variable",
            "type": "EQUALS"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "codetype",
        "paramValue": "clear_user_identities",
        "type": "NOT_EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

/**
 * Documentation
 * @see https://vyvojari.seznam.cz/identita/inzerent
 */
const log = require('logToConsole');
const callInWindow = require('callInWindow');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');
const Math = require('Math');
const makeInteger = require('makeInteger');
const isConsentGranted = require('isConsentGranted');
const addConsentListener = require('addConsentListener');
const templateStorage = require('templateStorage');
const Object = require('Object');


// Set default values (due to compatibility with previous versions)
data.model = data.model || 'vars';
data.consent_handling = data.consent_handling || 'consent_mode';
data.consent_name_remarketing = data.consent_name_remarketing || 'ad_storage';
data.consent_name_conversion = data.consent_name_conversion || 'analytics_storage';
data.consent_name_user_data = data.consent_name_user_data || 'ad_user_data';



/**
 * Checks if string contains at least one digit
 * @param str
 * @return boolean
 */
const containsAnyNumber = function(str) {
  str = ''+str;
  const nums = '0123456789';
  for (let i = 0; i < str.length; i++) {
    if (nums.indexOf(str[i]) > -1) return true;
  }
  return false;
};



/**
 * Set obj[key] proper value has value (is not null or undefied)
 *
 * @param object obj
 * @param string key
 * @param string|number mh
 * @param string|number vals
 * @return object
 */
const addParamIfSet = function(obj, key, mh, vals) {
  if (data.model === 'mh' && mh) obj[key] = mh;
  else if (vals) obj[key] = vals;
  return obj;
};


/**
 * Parses string in param. If last part contains a digit, uses that part as street number
 *
 * @param string
 * @return array[street, number]
 */
const parseStreetNo = function(street) {
  let parts = street.split(' ');
  let no = null;
  if (parts.length > 1 && containsAnyNumber(parts[parts.length - 1])) {
    no = parts[parts.length - 1];
    street = parts.slice(0, -1).join(' ');
  } else {
    no = '';
  }
  return [street, no];
};



/**
 * Evaluates user data. If some is available, it will be passed to Sklik script
 *
 * @param function callback
 * @return void
 */
const addUserData = function(onSuccess) {
  if (!isConsentGranted(data.consent_name_user_data)) {
    return onSuccess();
  } else if (data.consent_handling === 'consent_mode') {
    addConsentListener(data.consent_name_user_data, (consentType, granted) => {
      if (consentType === data.consent_name_user_data && !granted) {
        log('SKLIK: clearing user identity');
        callInWindow('sznIVA.IS.clearIdentities', ['said', 'secid', 'eid', 'aid', 'tid']);
      }
    });
  }
  
  let user = data.user || {};
  let address = {};
  let userData = {};
  const callback = function() {
    log('SKLIK: adding user data', userData);
    return onSuccess();
  };
  
  
  
  address = addParamIfSet(address, 'a1', user.country, data.country);
  address = addParamIfSet(address, 'a2', user.city, data.city);
  address = addParamIfSet(address, 'a3', user.street, data.street);
  address = addParamIfSet(address, 'a4', null, data.streetNumber);
  address = addParamIfSet(address, 'a5', user.postalCode, data.postalCode);
  
  if (address.a3 && !address.a4) {
    let s = parseStreetNo(address.a3);
    address.a3 = s[0];
    address.a4 = s[1];
  }
  
  userData = addParamIfSet(userData, 'eid', user.email, data.userEmail);
  userData = addParamIfSet(userData, 'tid', user.phone, data.userPhone);
  userData = addParamIfSet(userData, 'secid', user.secid, data.userCzechAdId);
  userData = addParamIfSet(userData, 'said', user.said, data.userSeznamAdId);
  if (Object.keys(address).length) {
    userData.aid = address;
  }
  
  if (Object.keys(userData).length === 0) {
    return callback();
  }
  
  
  // encode user email if needed
  if (userData.eid && (userData.eid.length != 64 || userData.eid.indexOf('@') > -1)) {
    let digest = callInWindow('_gtm_mh.sha256', userData.eid); // try to call MH hash
    if (digest) {
      userData.eid = digest;
    } else {
      const sha256 = require('sha256');
      sha256(userData.eid, (digest) => {
        userData.eid = digest;
        callInWindow('sznIVA.IS.updateIdentities', userData);
        return callback();
      }, (value) => { // failure
        log('SKLIK RETARGETING: EID evaluation failed -> removing value', value);
        userData.eid = undefined;
        callInWindow('sznIVA.IS.updateIdentities', userData);
        return callback();
      }, {outputEncoding: 'hex'});
      return;
    }
  }
  
  
  callInWindow('sznIVA.IS.updateIdentities', userData);
  return callback();
};




/**
 * Loads Sklik library and calls a callback
 *
 * @param function success callback
 * @param function error callback
 * @return void
 */
const loadLibrary = function(onSuccess, onError) {
  if (templateStorage.getItem('isScriptLoaded')) {
    return onSuccess();
  }
  
  const url = 'https://c.seznam.cz/js/rc.js';
  if (!queryPermission('inject_script', url)) {
    log('SKLIK: loading script failed due to missing permissions');
    return onError();
  }
  
  injectScript(url, () => {
    templateStorage.setItem('isScriptLoaded', true);
    onSuccess();
  }, () => {
    log('SKLIK: loading script failure');
    onError();
  });
};



/**
 * Calls a Sklik function for sending request
 * 
 * @param object parameters
 * @return void
 */
const sendRequest = function(params) {
  log('SKLIK: sending '+data.codetype+' request with params', params);
  const method = 'rc.'+data.codetype+'Hit';
  callInWindow(method, params);
  return data.gtmOnSuccess();
};




/**
 * Evaluates status of a consent
 * Possible return values:
 *
 *   0     consent denied (or not granted)
 *   1     consent granted
 *
 * @param consent_type
 * @return integer
 */
const getConsentState = function(consentType) {
  if (data.consent_handling === 'consent_mode') {
    return makeInteger(isConsentGranted(data['consent_name_'+consentType]));
  } else if (data.consent_handling === 'consent_variable') {
    let consent = data['consent_variable_'+consentType];
    if (consent === 'granted' || consent === 'true' || consent == true) return 1;
    else if (consent === 'denied' || consent === 'false' || consent == false) return 0;
    else return makeInteger(consent);
  }
  return 0;
};




if (data.codetype === 'retargeting') {

  const sendRemarketingHit = function(consent) {
    log('SKLIK RETARGETING: preparing request', data);
    let params = {
      'rtgId': data.id
    };
    
    if (consent > -1) params.consent = consent;
    if (data.url) params.rtgUrl = data.url;
    

    if (data.model === 'mh') {
      if (data.page && data.page.type) {
        if (data.page.type.indexOf('detail') > -1) {
          params.pageType = 'offerdetail';
        } else if (data.page.type.indexOf('category') > -1) {
          params.pageType = 'category';
        }
      }
      if (data.products && data.products.length) {
        params.itemId = data.products[0].id || '';
      }
      if (data.category) {
        if (data.categorySeznamKey) {
          params.category = data.page[data.categorySeznamKey] || '';
        } else {
          params.category = ((data.page && data.page.category) ? data.page.category.replaceAll('/', ' | ') : '') || '';
        }
      }

    } else { // model vars
      if (data.pagetype) params.pageType = data.pagetype || '';
      if (data.itemId) params.itemId = data.itemId || '';
      if (data.category) params.category = (data.category || '').split('/').join(' | ');
    }

    loadLibrary(function() {
      addUserData(function() {
        sendRequest(params);
      });
    }, data.gtmOnFailure);
  };

  

  let consent = getConsentState('remarketing');

  if (consent === 0 && !data.disableUpdateListener && data.consent_handling === 'consent_mode') {
    addConsentListener(data.consent_name_remarketing, (consentType, granted) => {
      log('SKLIK RETARGETING: callback called, consent:', granted);
      if (consentType === data.consent_name_remarketing && granted) {
        sendRemarketingHit(makeInteger(granted));
      }
    });
    log('SKLIK RETARGETING: callback inited');
    data.gtmOnSuccess();
  } else if (consent) {
    sendRemarketingHit(consent);
  } else {
    log('SKLIK RETARGETING: sending no hit due to missing consent');
    data.gtmOnSuccess();
  }

  

} else if (data.codetype === 'conversion') {

  const sendConversionHit = function(consent) {
    log('SKLIK CONVERSION: preparing request', data);
    
    let params = {
      'id': data.id
    };
    
    params = addParamIfSet(params, 'orderId', data.order ? data.order.id : null, data.orderId);
    params = addParamIfSet(params, 'value', data.order ? data.order.revenue : null, data.revenue);
    if (params.value) params.value = (Math.round(params.value * 100) / 100);
    

    if (data.zboziType) params.zboziType = data.zboziType;
    if (data.zboziId) params.zboziId = data.zboziId;
    
    if (consent > -1) params.consent = consent;
    

    loadLibrary(function() {
      addUserData(function() {
        sendRequest(params);
      });
    }, data.gtmOnFailure);
  };

  let consent = getConsentState('conversion');

  if (consent === 0 && !data.disableUpdateListener && data.consent_handling === 'consent_mode') {
    addConsentListener(data.consent_name_conversion, (consentType, granted) => {
      log('SKLIK CONVERSION: callback called, consent:', granted);
      if (consentType === data.consent_name_conversion && granted) {
        sendConversionHit(makeInteger(granted));
      }
    });
    log('SKLIK CONVERSION: callback inited, consent:', consent);
    data.gtmOnSuccess();
  }
  sendConversionHit(consent);
  

  
  
} else if (data.codetype === 'clear_user_identities') {
  log('SKLIK CLEARING USER IDENTITY');
  if (templateStorage.getItem('isScriptLoaded')) {
    callInWindow('sznIVA.IS.clearIdentities', ['said', 'secid', 'eid', 'aid', 'tid']);
  }
  
  
} else {
  log('Unknown codetype ' + data.codetype);
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rc"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rc.retargetingHit"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rc.conversionHit"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_gtm_mh.sha256"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sznIVA.IS.updateIdentities"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sznIVA.IS.clearIdentities"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://c.seznam.cz/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_template_storage",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Template - script was injected
  code: |-
    runCode(retargetingData);
    assertApi('injectScript').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: Conversion - request was sent
  code: |-
    conversionData.zboziType = 'standard';
    conversionData.zboziId = '54321';

    const expected = {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'zboziType': 'standard',
      'zboziId': '54321',
      'consent': 1
    };

    runCode(conversionData);

    assertApi('callInWindow').wasCalledWith('rc.conversionHit', expected);
- name: Conversion - zbozi_cz
  code: |-
    conversionData.zboziType = 'standard';
    conversionData.zboziId = '54321';

    const expected = {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'zboziType': 'standard',
      'zboziId': '54321',
      'consent': 1
    };

    runCode(conversionData);

    assertApi('callInWindow').wasCalledWith('rc.conversionHit', expected);
- name: Conversion - consent mode - approved
  code: |-
    let expected = {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'consent': 1
    };

    runCode(conversionData);
    assertApi('callInWindow').wasCalledWith('rc.conversionHit', expected);
- name: Conversion - consent mode - undefined
  code: |-
    let expected = {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'consent': 1
    };

    runCode(conversionData);
    assertApi('callInWindow').wasCalledWith('rc.conversionHit', expected);
- name: Conversion - consent mode - rejected
  code: |-
    consent = {
      'ad_storage': false,
      'ad_personalization': false,
      'ad_user_data': false,
      'analytics_storage': false,
    };

    let expected = {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'consent': 0
    };

    runCode(conversionData);
    assertApi('callInWindow').wasCalledWith('rc.conversionHit', expected);
- name: Conversion - consent from variable - approved
  code: |-
    conversionData.consent_handling = 'consent_variable';
    conversionData.consent_variable_conversion = true;
    conversionData.consent_variable_user_data = true;

    let expected = {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'consent': 1
    };

    runCode(conversionData);
    assertApi('callInWindow').wasCalledWith('rc.conversionHit', expected);
    assertApi('addConsentListener').wasNotCalled();
- name: Conversion - consent from variable - rejected
  code: |-
    conversionData.consent_handling = 'consent_variable';
    conversionData.consent_variable_conversion = false;
    conversionData.consent_variable_user_data = false;

    let expected = {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'consent': 0
    };

    runCode(conversionData);
    assertApi('callInWindow').wasCalledWith('rc.conversionHit', expected);
    assertApi('addConsentListener').wasNotCalled();
- name: Conversion - consent mode - rejected - listener was added
  code: |-
    consent.analytics_storage = false;
    consent.ad_user_data = false;

    runCode(conversionData);

    let expected = {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'consent': 0
    };

    runCode(conversionData);
    assertApi('callInWindow').wasCalledWith('rc.conversionHit', expected);
    assertApi('addConsentListener').wasCalled();
- name: Retargeting - basic retargeting
  code: |-
    mock('injectScript', function(url, onSuccess, onFailure) {
      onSuccess();
    });
    mock('copyFromWindow', (name) => {
      if (name === 'rc.retargetingHit') return function() {};
    });


    let expected = {
      'rtgId': 'ID123',
      'consent': 1
    };

    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', expected);
- name: Retargeting - category page - standard
  code: |-
    retargetingData.model = 'vars';
    retargetingData.pagetype = 'category';
    retargetingData.category = 'Jidlo/Pecivo/Bile pecivo/Rohliky';

    let expected = {
      'rtgId': 'ID123',
      'pageType': 'category',
      'category': 'Jidlo | Pecivo | Bile pecivo | Rohliky',
      'consent': 1
    };

    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', expected);
- name: Retargeting - offerdetail page - standard
  code: |-
    retargetingData.model = 'vars';
    retargetingData.pagetype = 'offerdetail';
    retargetingData.itemId = 'ITEM_123/4';

    let expected = {
      'rtgId': 'ID123',
      'pageType': 'offerdetail',
      'itemId': 'ITEM_123/4',
      'consent': 1
    };

    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', expected);
- name: Retargeting - custom URL
  code: |-
    retargetingData.url = 'https://example.com/foo?bar=1';

    let expected = {
      'rtgId': 'ID123',
      'rtgUrl': 'https://example.com/foo?bar=1',
      'consent': 1
    };

    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', expected);
- name: Retargeting - added update listener
  code: |-
    retargetingData.consent_handling = 'consent_mode';
    retargetingData.disableUpdateListener = false;
    mock('isConsentGranted', function(consentType) {
      return false;
    });

    runCode(retargetingData);

    assertApi('addConsentListener').wasCalled();
    assertApi('callInWindow').wasNotCalled();
- name: Retargeting - consent from variable - approved
  code: |-
    retargetingData.consent_handling = 'consent_variable';
    retargetingData.consent_variable_remarketing = 1;

    runCode(retargetingData);

    let expected = {
      'rtgId': 'ID123',
      'consent': 1
    };

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', expected);
    assertApi('addConsentListener').wasNotCalled();
- name: Retargeting - consent from variable - rejected
  code: |-
    retargetingData.consent_handling = 'consent_variable';
    retargetingData.consent_variable_remarketing = 0;

    runCode(retargetingData);

    assertApi('isConsentGranted').wasNotCalled();
    assertApi('callInWindow').wasNotCalled();
    assertApi('addConsentListener').wasNotCalled();
- name: User Data - Retargeting - data from MH
  code: |-
    runCode(retargetingDataMH);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', {
      'rtgId': 'ID123',
      'pageType': 'offerdetail',
      'itemId': 'ITEM_123/4',
      'consent': 1
    });
    assertApi('callInWindow').wasCalledWith('sznIVA.IS.updateIdentities', {
      'eid': '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f',
      'tid': '+420777123456'
    });
- name: User Data -Retargeting- data from vars
  code: |-
    retargetingData.model = 'vars';
    retargetingData.pagetype = 'category';
    retargetingData.category = 'Jidlo/Pecivo/Bile pecivo/Rohliky';
    retargetingData.userEmail = 'john.doe@example.com';
    retargetingData.userPhone = '+420777123456';
    retargetingData.country = 'Czechia';
    retargetingData.city = 'Brno';
    retargetingData.street = 'Veveří';
    retargetingData.streetNumber = '123';
    retargetingData.postalCode = '60200';


    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', {
      'rtgId': 'ID123',
      'pageType': 'category',
      'category': 'Jidlo | Pecivo | Bile pecivo | Rohliky',
      'consent': 1
    });
    assertApi('callInWindow').wasCalledWith('sznIVA.IS.updateIdentities', {
      'eid': '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f',
      'tid': '+420777123456',
      'aid': {
        'a1': 'Czechia',
        'a2': 'Brno',
        'a3': 'Veveří',
        'a4': '123',
        'a5': '60200',
      }
    });
- name: User Data - Retargeting - email hash from vars
  code: |-
    retargetingData.model = 'vars';
    retargetingData.pagetype = 'category';
    retargetingData.category = 'Jidlo/Pecivo/Bile pecivo/Rohliky';
    retargetingData.userEmail = '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f';
    retargetingData.userPhone = '+420777123456';
    retargetingData.country = 'Czechia';
    retargetingData.city = 'Brno';
    retargetingData.street = 'Veveří';
    retargetingData.streetNumber = '123';
    retargetingData.postalCode = '60200';


    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', {
      'rtgId': 'ID123',
      'pageType': 'category',
      'category': 'Jidlo | Pecivo | Bile pecivo | Rohliky',
      'consent': 1
    });
    assertApi('callInWindow').wasCalledWith('sznIVA.IS.updateIdentities', {
      'eid': '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f',
      'tid': '+420777123456',
      'aid': {
        'a1': 'Czechia',
        'a2': 'Brno',
        'a3': 'Veveří',
        'a4': '123',
        'a5': '60200',
      }
    });
- name: User Data - Retargeting - consent denied
  code: |-
    retargetingData.consent_handling = 'consent_mode';
    retargetingData.model = 'vars';
    retargetingData.pagetype = 'category';
    retargetingData.category = 'Jidlo/Pecivo/Bile pecivo/Rohliky';
    retargetingData.userEmail = '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f';
    retargetingData.userPhone = '+420777123456';
    retargetingData.country = 'Czechia';
    retargetingData.city = 'Brno';
    retargetingData.street = 'Veveří';
    retargetingData.streetNumber = '123';
    retargetingData.postalCode = '60200';

    mock('isConsentGranted', function(consentType) {
      if (consentType === 'ad_user_data') return false;
      return true;
    });


    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', {
      'rtgId': 'ID123',
      'pageType': 'category',
      'category': 'Jidlo | Pecivo | Bile pecivo | Rohliky',
      'consent': 1
    });
    assertApi('callInWindow').wasNotCalledWith('sznIVA.IS.updateIdentities', {
      'eid': '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f',
      'tid': '+420777123456',
      'aid': {
        'a1': 'Czechia',
        'a2': 'Brno',
        'a3': 'Veveří',
        'a4': '123',
        'a5': '60200',
      }
    });
- name: User Data - Conversion - data with consent
  code: |-
    conversionData.model = 'mh';

    conversionData.order = {
      'id': 'T_112233',
      'revenue': 99.10
    };

    conversionData.user = {
      'email': 'john.doe@example.com',
      'phone': '+420777123456',
      'country': 'Czechia',
      'city': 'Praha',
      'street': 'Václavské náměstí 18',
      'postalCode' : '16000'
    };

    runCode(conversionData);

    assertApi('callInWindow').wasCalledWith('rc.conversionHit', {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'consent': 1
    });
    assertApi('callInWindow').wasCalledWith('sznIVA.IS.updateIdentities', {
      'eid': '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f',
      'tid': '+420777123456',
      'aid': {
        'a1': 'Czechia',
        'a2': 'Praha',
        'a3': 'Václavské náměstí',
        'a4': '18',
        'a5': '16000',
      }
    });
- name: User Data - Conversion - not provided street number
  code: |-
    conversionData.model = 'mh';

    conversionData.order = {
      'id': 'T_112233',
      'revenue': 99.10
    };

    conversionData.user = {
      'email': 'john.doe@example.com',
      'phone': '+420777123456',
      'country': 'Czechia',
      'city': 'Praha',
      'street': 'Václavské náměstí',
      'postalCode' : '16000'
    };

    runCode(conversionData);

    assertApi('callInWindow').wasCalledWith('rc.conversionHit', {
      'id': 'ID123',
      'value': 99.10,
      'orderId': 'T_112233',
      'consent': 1
    });
    assertApi('callInWindow').wasCalledWith('sznIVA.IS.updateIdentities', {
      'eid': '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f',
      'tid': '+420777123456',
      'aid': {
        'a1': 'Czechia',
        'a2': 'Praha',
        'a3': 'Václavské náměstí',
        'a4': '',
        'a5': '16000',
      }
    });
- name: Clear User Identity - Function
  code: |
    const templateStorage = require('templateStorage');
    templateStorage.setItem('isScriptLoaded', true);
    runCode(clearIdentityData);
    assertApi('callInWindow').wasCalledWith('sznIVA.IS.clearIdentities', ['said', 'secid', 'eid', 'aid', 'tid']);
- name: Clear User Identity - From Listener
  code: |-
    retargetingData.model = 'vars';
    retargetingData.pagetype = 'category';
    retargetingData.category = 'Jidlo/Pecivo/Bile pecivo/Rohliky';
    retargetingData.userEmail = '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f';

    let removeConsentListener;

    let listenerAdded = false;
    let listenerCallback = function(consentStatus, listener) {
      assertThat(consentStatus).isEqualTo('ad_user_data');
      listenerAdded = true;
      removeConsentListener = listener;
    };


    mock('addConsentListener', listenerCallback);
    /**/


    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', {
      'rtgId': 'ID123',
      'pageType': 'category',
      'category': 'Jidlo | Pecivo | Bile pecivo | Rohliky',
      'consent': 1
    });
    assertApi('callInWindow').wasCalledWith('sznIVA.IS.updateIdentities', {
      'eid': '836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f'
    });


    assertThat(listenerAdded).isTrue();


    removeConsentListener('ad_user_data', false);

    assertApi('callInWindow').wasCalledWith('sznIVA.IS.clearIdentities', ['said', 'secid', 'eid', 'aid', 'tid']);
setup: |-
  let conversionData = {
    'codetype': 'conversion',
    'model': 'vars',
    'id': 'ID123',
    'revenue': 99.10,
    'orderId': 'T_112233',
    'consent_handling': 'consent_mode',
    'consent_name_remarketing': 'ad_storage',
    'consent_name_conversion': 'analytics_storage',
    'consent_name_user_data': 'ad_user_data',
    'disableUpdateListener': false
  };


  let retargetingData = {
    'id': 'ID123',
    'codetype': 'retargeting',
    'multipleHitsPerPage': false,
    'consent_handling': 'consent_mode',
    'consent_name_remarketing': 'ad_storage',
    'consent_name_conversion': 'analytics_storage',
    'consent_name_user_data': 'ad_user_data',
    'disableUpdateListener': false
  };



  let clearIdentityData = {
    'id': 'ID123',
    'codetype': 'clear_user_identities'
  };



  let retargetingDataMH = {
    'id': 'ID123',
    'codetype': 'retargeting',
    'multipleHitsPerPage': false,
    'consent_handling': 'consent_mode',
    'consent_name_remarketing': 'ad_storage',
    'consent_name_conversion': 'analytics_storage',
    'consent_name_user_data': 'ad_user_data',
    'disableUpdateListener': false,
    'model': 'mh',
    'page': {
      'type': 'detail'
    },
    'products': [{
      'id': 'ITEM_123/4'
    }],
    'user': {
      'email': 'john.doe@example.com',
      'phone': '+420777123456'
    }
  };


  mock('injectScript', function(url, onSuccess, onFailure) {
    onSuccess();
  });

  mock('sha256', function(inputString, onSuccess, onFailure, options) {
    if (inputString === 'john.doe@example.com') {
      return onSuccess('836f82db99121b3481011f16b49dfa5fbc714a0d1b1b9f784a1ebbbf5b39577f');
    }
    onFailure();
  });

  let consent = {
    'ad_storage': true,
    'ad_personalization': true,
    'ad_user_data': true,
    'analytics_storage': true,
  };

  mock('isConsentGranted', function(consentType) {
    switch (consentType) {
      case 'ad_storage':
        return consent.ad_storage;
      case 'ad_personalization':
        return consent.ad_personalization;
      case 'ad_user_data':
        return consent.ad_user_data;
      case 'analytics_storage':
        return consent.analytics_storage;
    }
    return false;
  });


___NOTES___

Created on 17. 5. 2020 0:30:14


