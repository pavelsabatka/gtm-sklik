___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "displayName": "Sklik",
  "categories": [
    "REMARKETING",
    "ANALYTICS",
    "ADVERTISING"
  ],
  "description": "Conversion \u0026 remarketing code for Sklik \u0026 Zbozi. Supporting RC.js code form May 2020.\n@author House of Rezac\n@version 2021-08-12",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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\u003d",
    "displayName": "pavelsabatka",
    "id": "github.com_pavelsabatka"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "clearOnCopy": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "displayName": "ID *",
    "simpleValueType": true,
    "name": "id",
    "type": "TEXT",
    "help": "Remarketing or conversion ID given from Sklik administration",
    "valueHint": "12345"
  },
  {
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "Conversion",
        "value": "conversion"
      },
      {
        "value": "retargeting",
        "displayValue": "Retargeting"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Code Type *",
    "simpleValueType": true,
    "name": "codetype",
    "type": "SELECT"
  },
  {
    "enablingConditions": [
      {
        "paramName": "codetype",
        "type": "EQUALS",
        "paramValue": "conversion"
      }
    ],
    "displayName": "Order",
    "name": "conversion",
    "groupStyle": "NO_ZIPPY",
    "type": "GROUP",
    "subParams": [
      {
        "type": "TEXT",
        "name": "orderId",
        "displayName": "Order ID",
        "simpleValueType": true,
        "canBeEmptyString": false,
        "valueHint": "",
        "help": "Unique transaction ID"
      },
      {
        "clearOnCopy": false,
        "displayName": "Revenue",
        "simpleValueType": true,
        "name": "revenue",
        "type": "TEXT",
        "help": "Total revenue of transaction",
        "valueHint": "12345.12"
      },
      {
        "type": "TEXT",
        "name": "zboziId",
        "displayName": "Zbozi.cz shop ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "^(|[0-9]{4,10})$"
            ],
            "enablingConditions": [],
            "errorMessage": "Value must be empty or must be numeric"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "zboziType",
        "displayName": "Zbozi.cz conversion type",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "standard",
            "displayValue": "Standard"
          },
          {
            "value": "limited",
            "displayValue": "Limited"
          },
          {
            "value": "sandbox",
            "displayValue": "Sandbox"
          }
        ],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "zboziId",
            "paramValue": "",
            "type": "PRESENT"
          }
        ],
        "defaultValue": "standard"
      }
    ]
  },
  {
    "enablingConditions": [
      {
        "paramName": "codetype",
        "type": "EQUALS",
        "paramValue": "retargeting"
      }
    ],
    "displayName": "Retargeting",
    "name": "remarketing",
    "groupStyle": "NO_ZIPPY",
    "type": "GROUP",
    "subParams": [
      {
        "clearOnCopy": false,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "displayName": "Model type",
        "defaultValue": "vars",
        "simpleValueType": true,
        "name": "model",
        "type": "RADIO",
        "radioItems": [
          {
            "displayValue": "Measurement Hub",
            "value": "mh"
          },
          {
            "displayValue": "Standard Variables",
            "value": "vars"
          }
        ],
        "help": "Measuremet Hub is object oriented standard of dataLayer. Standard variables means separated values for each Sklik parameter."
      },
      {
        "notSetText": "Not set",
        "clearOnCopy": false,
        "macrosInSelect": true,
        "selectItems": [],
        "enablingConditions": [
          {
            "paramName": "model",
            "type": "EQUALS",
            "paramValue": "mh"
          }
        ],
        "displayName": "{{aac.page}}",
        "simpleValueType": true,
        "name": "page",
        "type": "SELECT"
      },
      {
        "notSetText": "Not set",
        "clearOnCopy": false,
        "macrosInSelect": true,
        "selectItems": [],
        "enablingConditions": [
          {
            "paramName": "model",
            "type": "EQUALS",
            "paramValue": "mh"
          }
        ],
        "displayName": "{{aac.products}}",
        "defaultValue": "{{aac.products}}",
        "simpleValueType": true,
        "name": "products",
        "type": "SELECT"
      },
      {
        "help": "Category will use {{aac.page}}[KEY] value. If not set, standard category value will be used.",
        "enablingConditions": [
          {
            "paramName": "page",
            "type": "PRESENT",
            "paramValue": ""
          }
        ],
        "displayName": "Category Key",
        "simpleValueType": true,
        "name": "categorySeznamKey",
        "type": "TEXT",
        "canBeEmptyString": true
      },
      {
        "notSetText": "Not set",
        "macrosInSelect": false,
        "selectItems": [
          {
            "displayValue": "Category",
            "value": "category"
          },
          {
            "displayValue": "Offer detail",
            "value": "offerdetail"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "model",
            "type": "EQUALS",
            "paramValue": "vars"
          }
        ],
        "displayName": "Page type",
        "simpleValueType": true,
        "name": "pagetype",
        "type": "SELECT",
        "help": "Page type will be fetched from object page.type if this value is null. If it is needed to change that, you can submit new key."
      },
      {
        "enablingConditions": [
          {
            "paramName": "pagetype",
            "type": "EQUALS",
            "paramValue": "offerdetail"
          }
        ],
        "displayName": "Item ID",
        "simpleValueType": true,
        "name": "itemId",
        "type": "TEXT",
        "canBeEmptyString": false
      },
      {
        "enablingConditions": [
          {
            "paramName": "pagetype",
            "type": "EQUALS",
            "paramValue": "category"
          }
        ],
        "displayName": "Category",
        "simpleValueType": true,
        "name": "category",
        "type": "TEXT",
        "canBeEmptyString": false
      },
      {
        "displayName": "Custom URL",
        "simpleValueType": true,
        "name": "url",
        "type": "TEXT",
        "canBeEmptyString": true,
        "help": "Custom params can be put into URL here. Hostname and pathname of Custom URL must be same as real URL! Otherwise Sklik will not accept this parameter.\nYou can use it e.g. for scroll tracking or targeting to JS executed actions on page."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentMode",
    "displayName": "Consent Mode",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "consentWaitForUpdate",
        "checkboxText": "Wait for updates",
        "simpleValueType": true,
        "defaultValue": true,
        "help": "Used only in consent mode. If true, request will be sent in \"consent update\" listener (if consent was not given before). If \"wait_for_update\" value is not used, this flag should be unchecked."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const setInWindow = require('setInWindow');
const copyFromWindow = require('copyFromWindow');
const callInWindow = require('callInWindow');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');
const Math = require('Math');
const makeInteger = require('makeInteger');
const isConsentGranted = require('isConsentGranted');
const addConsentListener = require('addConsentListener');



if (data.codetype === 'retargeting') {
  
  

  const sendRemarketingHit = function(consent, completeTag) {
    log('SKLIK RETARGETING: preparing request', data);
    let params = {
      'rtgId': data.id,
      'consent': makeInteger(consent)
    };
    
    if (data.url) {
      params.rtgUrl = data.url;
    }
    

    if (data.model === 'mh') {
      if (data.page && data.page.type) {
        if (data.page.type.indexOf('detail') > -1) {
          params.pageType = 'offerdetail';
        } else if (data.page.type.indexOf('category') > -1) {
          params.pageType = 'category';
        }
      }
      if (data.products && data.products.length) {
        params.itemId = data.products[0].id || '';
      }
      if (data.categorySeznamKey) {
        params.category = data.page[data.categorySeznamKey] || '';
      } else {
        params.category = ((data.page && data.page.category) ? data.page.category.replaceAll('/', ' | ') : '') || '';
      }

    } else {
      if (data.pagetype) params.pageType = data.pagetype || '';
      if (data.itemId) params.itemId = data.itemId || '';
      if (data.category) params.category = (data.category || '').split('/').join(' | ');
    }

    
    
    if (copyFromWindow('rc.retargetingHit')) {
      callInWindow('rc.retargetingHit', params);
      log('SKLIK RETARGETING: status success', params);
      return data.gtmOnSuccess();
    } else {
      const url = 'https://c.imedia.cz/js/retargeting.js';
      if (queryPermission('inject_script', url)) {
        injectScript(url, () => {
          callInWindow('rc.retargetingHit', params);
          log('SKLIK RETARGETING: loading script success', params);
          return data.gtmOnSuccess();
        }, () => {
          log('SKLIK RETARGETING: loading script failure', params);
          return data.gtmOnFailure();
        });
       } else {
        log('SKLIK RETARGETING: status failure: request not allowed', params);
        return data.gtmOnFailure();
      }
    }
    
    if (completeTag) {
      log('SKLIK RETARGETING: callback inited');
      data.gtmOnSuccess();      
    }
  };

  
  let consent = isConsentGranted('ad_storage');
  if (consent || !data.consentWaitForUpdate) {
    sendRemarketingHit(consent, false);
  } else {
    addConsentListener('ad_storage', (consentType, granted) => {
      sendRemarketingHit(granted, true);
    });
  }



  

} else if (data.codetype === 'conversion') {

  let revenue = (data.model === 'mh' ? data.order.revenue : data.revenue) || null;
  revenue = (revenue ? (Math.round(revenue*100) / 100) : '');

  
  setInWindow('seznam_cId', data.id);
  setInWindow('seznam_value', revenue);
  if (data.orderId) setInWindow('seznam_orderId', data.orderId);
  if (data.zboziId) setInWindow('seznam_zboziId', data.zboziId);
  if (data.zboziType) setInWindow('seznam_zboziType', data.zboziType);
  let consent = isConsentGranted('analytics_storage');
  setInWindow('rc', {}, false);
  setInWindow('rc.consent', makeInteger(consent), true);
  
  
  const trackConversion = function(consent, completeTag) {
    const url = 'https://www.seznam.cz/rs/static/rc.js';
    if (queryPermission('inject_script', url)) {
      injectScript(url, () => {
        log('SKLIK CONVERSION: status success', data, ', consent:', consent);
        return data.gtmOnSuccess();
      }, () => {
        log('SKLIK CONVERSION: status failure', data, ', consent:', consent);
        return data.gtmOnFailure();
      });
    } else {
      log('SKLIK CONVERSION: status failure: request not allowed', data, ', consent:', consent);
      return data.gtmOnFailure();
    }


    if (completeTag) {
      log('SKLIK CONVERSION: callback inited');
      data.gtmOnSuccess();
    }
  };
  

  if (consent || !data.consentWaitForUpdate) {
    trackConversion(consent, false);
  } else {
    addConsentListener('analytics_storage', (consentType, granted) => {
      setInWindow('rc.consent', makeInteger(granted), true);
      trackConversion(granted, true);
    });
  }
  

} else {
  log('Unknown codetype ' + data.codetype);
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "seznam_cId"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "seznam_value"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "seznam_orderId"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "seznam_zboziId"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "seznam_zboziType"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rc"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rc.retargetingHit"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rc.consent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://c.imedia.cz/"
              },
              {
                "type": 1,
                "string": "https://www.seznam.cz/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Conversion - request was sent
  code: |-
    runCode(retargetingData);
    assertApi('injectScript').wasCalled();
- name: Conversion - params were submitted
  code: |-
    runCode(conversionData);
    assertApi('setInWindow').wasCalledWith('seznam_cId', 'ID123');
    assertApi('setInWindow').wasCalledWith('seznam_value', 99.12);
    assertApi('setInWindow').wasCalledWith('seznam_orderId', 'T_112233');
- name: Conversion - zbozi_cz
  code: |-
    let zboziData = {
      'codetype': 'conversion',
      'id': 'ID123',
      'revenue': 99.123,
      'orderId': 'T_112233',
      'zboziId': '54321',
      'zboziType': 'standard'
    };

    // Call runCode to run the template's code.
    runCode(zboziData);

    // Verify that the tag finished successfully.
    assertApi('setInWindow').wasCalledWith('seznam_zboziId', '54321');
    assertApi('setInWindow').wasCalledWith('seznam_zboziType', 'standard');
- name: Conversion - consent was given
  code: |-
    runCode(conversionData);
    mock('isConsentGranted', function(consentType) {
      return true;
    });
    assertApi('setInWindow').wasCalledWith('rc.consent', 1, true);
- name: Retargeting - request was sent
  code: |-
    runCode(retargetingData);
    assertApi('injectScript').wasCalled();
- name: Retargeting - basic retargeting
  code: |-
    mock('injectScript', function(url, onSuccess, onFailure) {
      onSuccess();
    });
    mock('copyFromWindow', (name) => {
      if (name === 'rc.retargetingHit') return function() {};
    });


    let expected = {
      'rtgId': 'ID123',
      'consent': 1
    };

    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', expected);
- name: Retargeting - category page - standard
  code: |-
    mock('injectScript', function(url, onSuccess, onFailure) {
      onSuccess();
    });
    mock('copyFromWindow', (name) => {
      if (name === 'rc.retargetingHit') return function() {};
    });


    retargetingData.model = 'vars';
    retargetingData.pagetype = 'category';
    retargetingData.category = 'Jidlo/Pecivo/Bile pecivo/Rohliky';

    let expected = {
      'rtgId': 'ID123',
      'consent': 1,
      'pageType': 'category',
      'category': 'Jidlo | Pecivo | Bile pecivo | Rohliky',
    };

    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', expected);
- name: Retargeting - offerdetail page - standard
  code: |-
    retargetingData.model = 'vars';
    retargetingData.pagetype = 'offerdetail';
    retargetingData.itemId = 'ITEM_123/4';



    mock('injectScript', function(url, onSuccess, onFailure) {
      onSuccess();
    });
    mock('copyFromWindow', (name) => {
      if (name === 'rc.retargetingHit') return function() {};
    });

    let expected = {
      'rtgId': 'ID123',
      'consent': 1,
      'pageType': 'offerdetail',
      'itemId': 'ITEM_123/4'
    };

    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', expected);
- name: Retargeting - custom URL
  code: |-
    retargetingData.url = 'https://example.com/foo?bar=1';

    mock('injectScript', function(url, onSuccess, onFailure) {
      onSuccess();
    });
    mock('copyFromWindow', (name) => {
      if (name === 'rc.retargetingHit') return function() {};
    });

    let expected = {
      'rtgId': 'ID123',
      'consent': 1,
      'rtgUrl': 'https://example.com/foo?bar=1'
    };

    runCode(retargetingData);

    assertApi('callInWindow').wasCalledWith('rc.retargetingHit', expected);
setup: |-
  let conversionData = {
    'codetype': 'conversion',
    'id': 'ID123',
    'revenue': 99.123,
    'orderId': 'T_112233'
  };


  let retargetingData = {
    'id': 'ID123',
    'codetype': 'retargeting',
    'multipleHitsPerPage': false
  };


___NOTES___

Created on 17. 5. 2020 0:30:14


